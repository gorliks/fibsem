
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.12">
    
    
      
        <title>Automation - FIBSEM Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0d440cfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#automation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="FIBSEM Docs" class="md-header__button md-logo" aria-label="FIBSEM Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FIBSEM Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Automation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="FIBSEM Docs" class="md-nav__button md-logo" aria-label="FIBSEM Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    FIBSEM Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        OpenFIBSEM
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../reference/" class="md-nav__link">
        FIBSEM
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#alignment" class="md-nav__link">
    Alignment
  </a>
  
    <nav class="md-nav" aria-label="Alignment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cross-correlation" class="md-nav__link">
    Cross Correlation
  </a>
  
    <nav class="md-nav" aria-label="Cross Correlation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filtering" class="md-nav__link">
    Filtering
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#masking" class="md-nav__link">
    Masking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#movement" class="md-nav__link">
    Movement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilities" class="md-nav__link">
    Utilities
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helper-functions" class="md-nav__link">
    Helper Functions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feature-detection" class="md-nav__link">
    Feature Detection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fibsem.detection.utils.Feature" class="md-nav__link">
    fibsem.detection.utils.Feature
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fibsem.detection.utils.FeatureType" class="md-nav__link">
    fibsem.detection.utils.FeatureType
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#machine-learning" class="md-nav__link">
    Machine Learning
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="automation">Automation</h1>
<p>OpenFIBSEM provides a number of modules to support automation.</p>
<h2 id="alignment">Alignment</h2>
<p>The alignment module contains functions are aligning reference images, and tools and parameters for adjusting these alignments.</p>
<p>WIP: images</p>
<h3 id="cross-correlation">Cross Correlation</h3>
<p>The primary alignment method is fourier cross-correlation to a reference image. The following helper function provides the the methods for alignment, and the required movements, as well as parameters for tuning.</p>
<pre><code class="language-python">def align_using_reference_images(
    microscope: SdbMicroscopeClient,
    settings: MicroscopeSettings,
    ref_image: AdornedImage,
    new_image: AdornedImage,
    ref_mask: np.ndarray = None,
    xcorr_limit: int = None,
    constrain_vertical: bool = False,
    beam_shift: bool = False,
    lp_px: int  = 128, 
    hp_px: int = 8,  
    sigma: int = 6,
) -&gt; bool:
    &quot;&quot;&quot;Align new image to reference image using crosscorrelation

    Args:
        microscope (SdbMicroscopeClient): microscope client
        settings (MicroscopeSettings): microscope settings
        ref_image (AdornedImage): reference image
        new_image (AdornedImage): new image
        ref_mask (np.ndarray, optional): reference mask. Defaults to None.
        xcorr_limit (int, optional): crosscorrelation limit. Defaults to None.
        constrain_vertical (bool, optional): constrain vertical movement. Defaults to False.
        beam_shift (bool, optional): use beam shift. Defaults to False.
        lp_px (int, optional): lowpass filter size. Defaults to 128.
        hp_px (int, optional): highpass filter size. Defaults to 8.
        sigma (int, optional): gaussian filter sigma. Defaults to 6.
    Returns:
        bool: True if alignment was successful, False otherwise
    &quot;&quot;&quot;
</code></pre>
<p>In order to tune the alignment the user can adjust the following:</p>
<h4 id="filtering">Filtering</h4>
<p>The cross correlation alignment can be tuned by adjusting the bandpass filters; lowpass, highpass; and sigma. These filters are applied in fourier space.
- <code>lowpass</code>: upper pixel distance bound
- <code>highpass</code>: lower pixel distance bound
- <code>sigma</code>: blur applied to bandpass mask boundary</p>
<p>The effect of these filters on the bandpass mask is shown below:</p>
<p>The following figure shows the effect of changing these parameters on the cross-correlation:</p>
<h4 id="masking">Masking</h4>
<p>We provide a number of masking utilities: </p>
<ul>
<li><code>circle_mask</code>: mask a circular area of the image. </li>
<li><code>bandpass_mask</code>: mask a bandpass area of the image (donut)</li>
<li><code>rect_mask</code>: mask a rectangular area of the image</li>
<li><code>area_mask</code>: mask quarters of the image specified by left, right, upper, and lower params</li>
<li><code>vertical_mask</code>: mask a central vertical area of the image</li>
<li><code>invert</code>: invert the mask</li>
</ul>
<p>These masks can be passed to the <code>ref_mask</code>for use in the alignment, and are available in <code>fibsem.imaging.masks</code>. Many of these masking functions contain additional parameters, so please see the implementation for details. </p>
<h4 id="movement">Movement</h4>
<p>By default, the function will move the stage to align the reference image. The following parameters adjust this movement. </p>
<ul>
<li><code>constrain_vertical</code>: this flag will constrain the stage to move only vertically (z). This is useful when attempting to correct the eucentric position using alignment.</li>
<li><code>beam_shift</code>: this flag will adjust the shift the beam instead of moving the stage. The beam shift is more precise than the mechanical stage, but has a much lower range of movement (~10um?, check this)</li>
</ul>
<h3 id="utilities">Utilities</h3>
<p>We also provide a number of utility functions that can help with crosscorrelation. For example:</p>
<ul>
<li><code>rotate_image</code>: rotate the image 180deg while preserving metadata</li>
<li><code>match_image_settings</code>: match the image settings used for reference image</li>
</ul>
<p>These utilities are available in <code>fibsem.imaging.utils</code>.</p>
<h3 id="helper-functions">Helper Functions</h3>
<p>The <code>fibsem.alignment</code> module contains more helper functions for performing alignment workflows:</p>
<ul>
<li><code>correct_stage_drift</code>: multi-step alignment</li>
<li><code>eucentric_correct_stage_drift</code>: multi-step alignment + eucentric alignment</li>
</ul>
<h2 id="feature-detection">Feature Detection</h2>
<p>We provide some feature detection functions and workflows primarly centred around the liftout workflow. These are customisable to the user's needs.</p>
<p>The primary detection workflow uses the following to run the feature detection, transform coordinate systems, and optionally allows the user to validate the result. For more information on the user validation please see <a href="../ml/">ml.md</a>.</p>
<pre><code class="language-python">def detect_features_v2(
    microscope: SdbMicroscopeClient,
    settings: MicroscopeSettings,
    features: tuple[Feature],
    validate: bool = True,
    mask_radius: int = 256,
) -&gt; DetectedFeatures:

    &quot;&quot;&quot;Detect features in microscope image.

    Args:
        microscope (SdbMicroscopeClient): microscope client
        settings (MicroscopeSettings): microscope settings
        features (tuple[Feature]): features to detect
        validate (bool, optional): whether to validate features. Defaults to True.
        mask_radius (int, optional): radius of mask to apply to image. Defaults to 256.

    Returns:
        DetectedFeatures: detected features
    &quot;&quot;&quot;
    ...

</code></pre>
<p>The supported Feature Types are as follows:</p>


<div class="doc doc-object doc-class">


<a id="fibsem.detection.utils.Feature"></a>
  <div class="doc doc-contents first">



        <details class="quote">
          <summary>Source code in <code>fibsem/detection/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Feature</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">FeatureType</span> <span class="c1"># rename from type to type</span>
    <span class="n">feature_px</span><span class="p">:</span> <span class="n">Point</span>  <span class="o">=</span> <span class="kc">None</span> <span class="c1"># x, y (image)</span>
    <span class="n">feature_m</span><span class="p">:</span> <span class="n">Point</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># x, y (microscope image coord)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">


<a id="fibsem.detection.utils.FeatureType"></a>
  <div class="doc doc-contents first">
      <p class="doc doc-class-bases">
        Bases: <code><span title="enum.Enum">Enum</span></code></p>



        <details class="quote">
          <summary>Source code in <code>fibsem/detection/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">FeatureType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">LamellaCentre</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">NeedleTip</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">LamellaRightEdge</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">LamellaLeftEdge</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">LandingPost</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ImageCentre</span> <span class="o">=</span> <span class="mi">6</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div><h2 id="machine-learning">Machine Learning</h2>
<p>We provide a basic machine learning pipeline and workflow. Currently only segmentation models are supported, but more will be added in the future.</p>
<p>For detailed information on the machine learning tools, please see <a href="../ml/">Machine Learning</a>.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.4b2c34cd.min.js"></script>
      
    
  </body>
</html>